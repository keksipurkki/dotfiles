" vim: nowrap fdm=marker
"
" File:         vimrc
" Last Change:  2019-10-12T16:09:52+0300

let &packpath.=','.expand('<sfile>:h')
let &rtp.=','.expand('<sfile>:h')

syntax on
filetype plugin indent on

" Settings {{{1
set shellcmdflag+=l " Read ~/.profile

let mapleader = ";"
let maplocalleader = ";"
set completeopt=longest,menuone
set guicursor+=a:blinkon0
set guifont=Monego:h14

if has('gui_running')
  set lines=80 columns=90
endif

if !has('gui_running')
  colorscheme terminal
endif

set hidden
set autoread
set directory=/tmp
set guioptions-=T
set ignorecase
set incsearch
set modeline
set nobackup
set nowritebackup
set nu
set scrolloff=8
set cmdheight=1
set updatetime=300
set background=light
set laststatus=2
set shortmess+=c
set signcolumn=yes
set smartcase
set sts=2 sw=2 et
set t_Co=256
set vb t_vb=

" Jump to the line that was last edited
function! LastLine()
  if line("'\"") > 1 && line("'\"") <= line("$") |
    exe "normal! g`\"" |
  endif
endfunction
autocmd BufReadPost * silent call LastLine()

autocmd FileType yaml setlocal ts=2 sts=2 sw=2 expandtab
autocmd BufRead,BufNewFile *.cwiki setlocal ft=confluencewiki

" Git
command! GitRoot :execute 'lcd' systemlist('git rev-parse --show-toplevel')[0]
command! -nargs=* GitLoadEm :args `set -f ; printf \"\%s\\n\" \"$(git grep --cached -Il '' )\"`

" Mappings {{{1
noremap + "+
noremap TT :tabe<CR>
noremap Y y$
noremap D d$
noremap <C-L> :redraw!<CR>

cabbrev <expr> E ((getcmdtype() == ':' && getcmdpos() <= 2)? 'e' : 'E')
cabbrev <expr> W ((getcmdtype() == ':' && getcmdpos() <= 2)? 'w' : 'W')
cabbrev <expr> Q ((getcmdtype() == ':' && getcmdpos() <= 2)? 'q' : 'Q')
cabbrev res Res

command! -range=% CRLFify :e ++ff=dos
command! DosToUnix :e ++ff=dos | :setlocal ff=unix | :w
command! Vimrc :e $MYVIMRC
command! TakeMeHere :lcd %:p:h
command! -range=% ValidateJSON <line1>,<line2>:!python -mjson.tool
command! -range=% ValidateXML <line1>,<line2>:!tidy -qi -xml
command! -range=% StripSpaces <line1>,<line2>:s/\s\+$//g|w
command! -range=% Indent <line1>,<line2>:!indent
command! -range=% HtmlPrettier <line1>,<line2>:!tidy -qi -utf8 || true
command! -range=% SwiftPrettier <line1>,<line2>:!swift format

" CSV
function! CSVFormat()
  %substitute/\t/;/g
  %substitute/,/./g
  %substitute///g
  global/^\s*$/d
endfunction
command! -range=% CSVPrettier :call CSVFormat()

" Filetypes {{{1

augroup txt
  au BufRead,BufNewFile *.txt setlocal tw=72 fo=t
augroup END

au FileType typescript setlocal et
au Filetype markdown setlocal tw=80

let g:is_bash=1
let g:tex_flavor = 'latex'
let g:tex_comment_nospell= 1
let g:tex_nine_config = {
      \'compiler' : 'latex',
      \'viewer': {'app': 'open', 'target': 'pdf'},
      \}

let netrw_browsex_viewer = "open"

" Vimdiff
if &diff
  noremap <buffer> <C-F> ]c
  noremap <buffer> <C-B> [c
  noremap <buffer> dp zRdp
  noremap <buffer> do zRdo
endif

" Spell checking
noremap <D-s> ]s
noremap <D-A-s> [s

"Colors {{{1
let g:airline_powerline_fonts=0
function! ColorFixes()
  hi LineNr guibg=white guifg=darkgrey
  hi SignColumn guibg=white
  hi CocErrorSign    guibg=white guifg=#ff0000
  hi CocWarningSign  guibg=white guifg=#ff922b
  hi CocInfoSign     guibg=white guifg=#fab005
  hi CocHintSign     guibg=white guifg=#15aabf
  hi CocErrorHighlight gui=underline guisp=#ff0000
endfunction
autocmd BufReadPost * silent call ColorFixes()

" JavaScript {{{1
let g:javascript_plugin_flow = 0
let g:vim_jsx_pretty_enable_jsx_highlight = 0
let g:vim_jsx_pretty_colorful_config = 1

" Override default functionalities with CoC/LSPs {{{1
nmap <silent> gd <Plug>(coc-definition)
nmap <silent> gy <Plug>(coc-type-definition)
nmap <silent> gi <Plug>(coc-implementation)
nmap <silent> gr <Plug>(coc-references)
nmap <leader>rn <Plug>(coc-rename)
autocmd CursorHold * silent call CocActionAsync('highlight')
